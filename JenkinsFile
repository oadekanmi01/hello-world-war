pipeline {
    agent any
	stages {
	    stage('SCM checkout') {
		    steps {
				cleanWs()
			    catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
               sh "exit 0"
               }      
			   sh 'mvn clean install -Dmaven.test.skip=true'
			   archiveArtifacts artifacts: 'dist/hello-world-war-1.0.0.war'
				  
			}
		}
		stage('DeployToTest') {
		    when {
		        branch 'master'
		    }
		    steps {
		        withCredentials([usernamePassword(credentialsId: 'web-App', usernameVariable: 'USERNAME', passwordVariable: 'USERPASS')]) {
		            sshPublisher(
		                failOnError: true,
		                continueOnError: false,
		                publishers: [
		                    sshPublisherDesc(
		                        configName: 'test-dz-ec2',
		                        sshCredentials: [
		                            username: "$USERNAME",
		                            encryptedPassphrase: "$USERPASS"
		                        ], 
		                        transfers: [
		                            sshTransfer(
		                                sourceFiles: 'dist/hello-world-war-1.0.0.war',
		                                removePrefix: 'dist/',
		                                remoteDirectory: '/tmp',
										execCommand: 'sudo systemctl stop tomcat && sudo rm -rf /var/lib/tomcat/webapps/hello-world-war*.war && sudo mv /tmp/hello-world-war-1.0.0.war /var/lib/tomcat/webapps/  && chown tomcat. 
		                            )
		                        ]
		                    )
		                ]
		            )
		        }
		    }
		}
	}
}
